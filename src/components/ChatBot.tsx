import { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { ScrollArea } from '@/components/ui/scroll-area';
import Icon from '@/components/ui/icon';

interface Message {
  text: string;
  isBot: boolean;
}

const chatKnowledgeBase: Record<string, string> = {
  'чем вы занимаетесь': 'ЮР Недвижимость - это полный комплекс услуг на рынке недвижимости Воронежа: купля-продажа, аренда, ипотека, юридическое сопровождение.',
  'где вы находитесь': 'Наш офис: Московский проспект, д. 114 В, офис 200, Воронеж. Работаем ежедневно с 10:00 до 20:00.',
  'адрес': 'Московский проспект, д. 114 В, офис 200, Воронеж.',
  'как добраться': 'Мы находимся по адресу: Московский проспект, д. 114 В, офис 200. Удобная транспортная развязка, парковка рядом.',
  'телефон': 'Наш телефон: +7 980 555 75 80. Звоните, мы всегда рады помочь!',
  'почта': 'Email: yur.nedv@mail.ru. Также мы в VK (https://vk.com/yur.nedv) и Telegram (https://t.me/yur_nedv).',
  'контакты': 'Телефон: +7 980 555 75 80, Email: yur.nedv@mail.ru, VK: vk.com/yur.nedv, Telegram: t.me/yur_nedv',
  'график работы': 'Мы работаем ежедневно с 10:00 до 20:00. Заявки принимаем онлайн круглосуточно.',
  'юр расшифровка': 'ЮР - это Юрист Риэлтор. Мы объединяем риэлторские услуги с полной юридической поддержкой.',
  
  'продать квартиру': 'Мы поможем быстро и выгодно продать вашу квартиру: оценка, подготовка документов, поиск покупателей, юридическое сопровождение.',
  'сколько стоит продажа': 'Стоимость услуг по продаже зависит от объекта. Первая консультация бесплатная. Позвоните +7 980 555 75 80 для расчета.',
  'документы для продажи': 'Для продажи нужны: паспорт, правоустанавливающие документы, выписка ЕГРН, согласие супруга (если есть), справка об отсутствии долгов.',
  'как быстро продать': 'Срок продажи зависит от объекта и цены. В среднем 1-3 месяца. Мы ускоряем процесс благодаря большой базе покупателей.',
  
  'купить квартиру': 'Поможем подобрать квартиру под ваши требования: район, бюджет, планировка. Проверим юридическую чистоту и сопроводим сделку.',
  'подбор квартиры': 'Подбираем варианты по вашим критериям: район, количество комнат, этаж, бюджет. Организуем просмотры и переговоры.',
  'проверка квартиры': 'Проверяем: историю собственников, обременения, долги по ЖКХ, законность перепланировки, права третьих лиц.',
  'юридическая чистота': 'Да! Проверяем все: собственники, обременения, долги, перепланировки, судебные споры. Гарантируем безопасность сделки.',
  
  'ипотека': 'Помогаем оформить ипотеку в ведущих банках Воронежа. Подбираем лучшие условия, готовим документы, сопровождаем до одобрения.',
  'документы для ипотеки': 'Нужны: паспорт, СНИЛС, справка 2-НДФЛ или справка о доходах по форме банка, трудовая книжка или договор.',
  'какие банки': 'Работаем со всеми крупными банками: Сбербанк, ВТБ, Альфа-Банк, Россельхозбанк, Газпромбанк и другие.',
  'процент по ипотеке': 'Ставки от 8% до 20% в зависимости от программы, первоначального взноса и банка. Подберем лучшие условия для вас.',
  'первоначальный взнос': 'Обычно от 10% до 20% от стоимости жилья. Есть программы с минимальным взносом от 0% (для семей с детьми).',
  'плохая кредитная история': 'Работаем и с такими случаями. Есть банки, одобряющие ипотеку при негативной истории. Нужен больший взнос.',
  
  'юридическое сопровождение': 'Полная юридическая поддержка сделки: проверка документов, составление договоров, регистрация права собственности.',
  'зачем юрист': 'Юрист защитит от рисков: обременений, долгов, мошенничества, незаконных перепланировок. Безопасность сделки - наш приоритет.',
  'стоимость юриста': 'Стоимость зависит от сложности сделки. Консультация бесплатная. Позвоните для точного расчета: +7 980 555 75 80',
  
  'сдать квартиру': 'Поможем найти надежных арендаторов, оформить договор, провести осмотр и передачу квартиры.',
  'поиск арендаторов': 'Размещаем объявления на всех площадках, проверяем арендаторов, организуем просмотры, оформляем договор.',
  'договор аренды': 'Составляем юридически грамотный договор аренды, защищающий интересы собственника.',
  
  'страхование ипотеки': 'Поможем оформить страхование ипотеки на выгодных условиях: жизнь, здоровье, титул, имущество.',
  'титульное страхование': 'Титульное страхование защищает от риска потери права собственности из-за оспаривания сделки третьими лицами.',
  'сколько стоит страховка': 'Стоимость 0,3-1% от суммы ипотеки в год. Зависит от программы и выбранных рисков.',
  
  'деньги под залог': 'Выдаем денежные средства под залог недвижимости на выгодных условиях. Быстрое оформление, минимум документов.',
  'проценты под залог': 'Ставка от 12% годовых. Зависит от суммы, срока и типа залогового имущества.',
  'срок под залог': 'Срок от 6 месяцев до 10 лет. Возможно досрочное погашение без штрафов.',
  
  'оценка недвижимости': 'Профессиональная оценка квартиры, дома, земли для продажи, ипотеки, нотариуса. Официальный отчет за 1-2 дня.',
  'стоимость оценки': 'Стоимость оценки квартиры от 3000 руб. Зависит от типа объекта и срочности.',
  'для чего оценка': 'Оценка нужна для: ипотеки, нотариальных сделок, продажи, раздела имущества, налогообложения.',
  'сколько делается оценка': 'Стандартная оценка 1-2 рабочих дня. Срочная оценка - в течение дня за доплату.',
  
  'договор купли-продажи': 'Составляем юридически грамотные договоры купли-продажи недвижимости с учетом всех нюансов сделки.',
  'стоимость договора': 'Стоимость составления договора от 5000 руб. Консультация бесплатная.',
  'что в договоре': 'В договоре указываются: стороны, объект, цена, порядок расчетов, передача объекта, ответственность сторон.',
  
  'новостройки': 'Продаем квартиры в новостройках Воронежа напрямую от застройщиков без комиссии. Акции и спецпредложения.',
  'комиссия новостройки': 'Да, мы работаем напрямую с застройщиками, поэтому комиссию не берем. Вы платите только застройщику.',
  'какие новостройки': 'Работаем со всеми крупными застройщиками Воронежа. Более 50 ЖК на выбор в разных районах.',
  'акции застройщиков': 'Всегда есть актуальные акции: скидки, рассрочки, ипотека от 0,1%. Позвоните, расскажем подробнее!',
  
  'материнский капитал': 'Да, помогаем использовать материнский капитал при покупке жилья: ипотека, покупка, строительство.',
  'дду': 'ДДУ (Договор долевого участия) - договор с застройщиком на покупку квартиры в строящемся доме. Защищен законом 214-ФЗ.',
  'риски новостройки': 'Основные риски: задержка сроков сдачи, банкротство застройщика. Мы работаем только с надежными компаниями.',
  
  'налоги при покупке': 'При покупке налог не платится. При продаже квартиры менее 5 лет в собственности - НДФЛ 13% с дохода.',
  'налоги при продаже': 'Если квартира в собственности менее 5 лет (3 года для единственного жилья), платится НДФЛ 13% с дохода от продажи.',
  'вычет при покупке': 'Можно вернуть 13% от стоимости жилья (до 260 тыс. руб.) и 13% от процентов по ипотеке (до 390 тыс. руб.).',
  
  'вторичка или новостройка': 'Вторичка: готовое жилье, можно сразу въехать. Новостройка: современные планировки, новый дом, ждать сдачу.',
  'обременение': 'Обременение - ограничение прав на недвижимость: ипотека, арест, рента, опека. Мы всегда проверяем наличие обременений.',
  'эскроу счет': 'Эскроу - специальный счет в банке, где деньги покупателя хранятся до сдачи дома. Защита от недобросовестного застройщика.',
  
  'срок сделки': 'Сделка купли-продажи занимает 2-4 недели: подготовка документов (1-2 недели), регистрация в Росреестре (7-10 дней).',
  'присутствие на сделке': 'Можно оформить доверенность, если не можете присутствовать лично. Но лучше быть на всех этапах сделки.',
  'расчет при покупке': 'Расчет через банковскую ячейку, аккредитив или счет эскроу. Гарантируем безопасность передачи денег.',
  'ипотечные каникулы': 'Ипотечные каникулы - отсрочка платежей до 6 месяцев при тяжелой жизненной ситуации. Оформляются через банк.',
  
  'перепланировка': 'Узаконим перепланировку: соберем документы, получим разрешения, внесем изменения в техплан и ЕГРН.',
  'долги по жкх': 'Проверяем наличие долгов по ЖКХ перед покупкой. Долги переходят с квартирой, если не закрыты продавцом.',
  'выписка егрн': 'Выписка ЕГРН - официальный документ о собственнике, характеристиках объекта, обременениях. Заказываем за 1-3 дня.',
  
  'приветствие': 'Здравствуйте! Я виртуальный помощник ЮР Недвижимость. Готов ответить на ваши вопросы о недвижимости.',
  'привет': 'Здравствуйте! Чем могу помочь?',
  'спасибо': 'Пожалуйста! Обращайтесь, если возникнут еще вопросы. Телефон: +7 980 555 75 80',
  'благодарю': 'Всегда рады помочь! Если нужна консультация специалиста, звоните: +7 980 555 75 80'
};

export default function ChatBot() {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([
    { text: 'Здравствуйте! Я виртуальный помощник ЮР Недвижимость. Задайте мне любой вопрос о недвижимости, и я постараюсь помочь!', isBot: true }
  ]);
  const [input, setInput] = useState('');
  const scrollRef = useRef<HTMLDivElement>(null);
  const [sessionId] = useState(() => `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  const findAnswer = (question: string): string => {
    const q = question.toLowerCase().trim();
    
    for (const [key, value] of Object.entries(chatKnowledgeBase)) {
      if (q.includes(key)) {
        return value;
      }
    }
    
    return 'Извините, я не нашел точного ответа на ваш вопрос. Для детальной консультации позвоните нам по телефону +7 980 555 75 80 или оставьте заявку на сайте.';
  };

  const saveChatMessage = async (message: string, isBot: boolean) => {
    try {
      await fetch('https://functions.poehali.dev/save-chat-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          message,
          is_bot: isBot
        })
      });
    } catch (error) {
      console.error('Failed to save chat message:', error);
    }
  };

  const handleSend = () => {
    if (!input.trim()) return;

    const userMessage = { text: input, isBot: false };
    setMessages(prev => [...prev, userMessage]);
    saveChatMessage(input, false);

    const answer = findAnswer(input);
    const botMessage = { text: answer, isBot: true };
    
    setTimeout(() => {
      setMessages(prev => [...prev, botMessage]);
      saveChatMessage(answer, true);
    }, 500);

    setInput('');
  };

  return (
    <>
      {!isOpen && (
        <Button
          onClick={() => setIsOpen(true)}
          className="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-primary hover:bg-primary/90 shadow-2xl z-50 p-0"
          size="icon"
        >
          <Icon name="MessageCircle" size={28} className="text-white" />
        </Button>
      )}

      {isOpen && (
        <Card className="fixed bottom-6 right-6 w-96 h-[600px] shadow-2xl z-50 flex flex-col">
          <CardHeader className="bg-primary text-white rounded-t-lg pb-4">
            <div className="flex justify-between items-center">
              <CardTitle className="text-lg flex items-center gap-2">
                <Icon name="MessageCircle" size={24} />
                Чат-бот ЮР
              </CardTitle>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setIsOpen(false)}
                className="text-white hover:bg-primary/90"
              >
                <Icon name="X" size={20} />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="flex-1 flex flex-col p-0">
            <ScrollArea className="flex-1 p-4" ref={scrollRef}>
              <div className="space-y-4">
                {messages.map((msg, i) => (
                  <div
                    key={i}
                    className={`flex ${msg.isBot ? 'justify-start' : 'justify-end'}`}
                  >
                    <div
                      className={`max-w-[80%] rounded-lg px-4 py-2 ${
                        msg.isBot
                          ? 'bg-gray-100 text-gray-800'
                          : 'bg-primary text-white'
                      }`}
                    >
                      <p className="text-sm">{msg.text}</p>
                    </div>
                  </div>
                ))}
              </div>
            </ScrollArea>
            <div className="p-4 border-t">
              <div className="flex gap-2">
                <Input
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="Введите ваш вопрос..."
                  className="flex-1"
                />
                <Button
                  onClick={handleSend}
                  className="bg-primary hover:bg-primary/90"
                  size="icon"
                >
                  <Icon name="Send" size={20} />
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </>
  );
}